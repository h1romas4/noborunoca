name: Build-Release

on:
  workflow_call:
    inputs:
      release:
        description: "release"
        type: boolean
        required: true

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Z88DK Toolchain Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
          sudo apt-get install -y ragel re2c dos2unix texinfo texi2html gdb curl cpanminus ccache libboost-all-dev libmodern-perl-perl libyaml-perl liblocal-lib-perl libcapture-tiny-perl libpath-tiny-perl libtest-differences-perl libtext-table-perl libdata-hexdump-perl libregexp-common-perl libclone-perl
          cpanm App::Prove Capture::Tiny::Extended CPU::Z80::Assembler Data::HexDump File::Path List::Uniq Modern::Perl Object::Tiny::RW Test::Cmd Test::Cmd::Common Test::Harness Test::HexDifferences Text::Table YAML::Tiny
          eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib)
          git clone --recursive https://github.com/z88dk/z88dk.git
          pushd z88dk
          git checkout 9ffe204 # z88dk v2.2
          ./build.sh
          ls -laF bin/
          popd
          ls -laF

      - name: Build
        run: |
          export Z88DK_HOME=$(pwd)/z88dk/
          export ZCCCFG=${Z88DK_HOME}/share/z88dk/lib/config
          export PATH=${Z88DK_HOME}/bin:${PATH}
          mkdir build
          cd build
          /usr/bin/cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/z88dk.cmake -GNinja ..
          ninja

      - name: Check
        run: |
          TARGET=dist/noborunoca.rom
          ls -laF ${TARGET}
          file ${TARGET} | grep 'MSX ROM' | grep '0x4010'
          md5sum ${TARGET}

      - uses: ncipollo/release-action@v1
        if: ${{ inputs.release }}
        with:
          artifacts: "dist/noborunoca.rom"
          token: ${{ secrets.GITHUB_TOKEN }}
